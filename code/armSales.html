<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"></script>
  <script src="https://d3js.org/d3-queue.v3.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <h1 style="text-align: center; color: deepskyblue">
      <bold> United States Arms Sales </bold>
    </h1>    
  <style>
svg {
    width: 100%;
    height: 100%;
    position: center;
}
.hidden {
      display: none;
}
div.tooltip {
      color: #222; 
      background: #BDE8F0; 
      border-radius: 3px; 
      box-shadow: 0px 0px 2px 0px #a6a6a6; 
      padding: .2em; 
      text-shadow: #f5f5f5 0 1px 0;
      opacity: 0.9; 
      position: absolute;
  </style>
</head>

<svg width="1200" height="850"></svg>
<svg width="1200" height="850" id="bar"></svg>
<div class="tooltip"></div>
<body>
<script>
var margin = {top: 10, right: 10, bottom: 100, left: 40};
var width = 960 - margin.left - margin.right;
var height = 500 - margin.top - margin.bottom;
var projection = d3.geoNaturalEarth1()
                   .center([0, 15]) 
                   .rotate([-9,0])
                   .scale([1300/(2*Math.PI)]) 
                   .translate([450,300]);
var path = d3.geoPath()
             .projection(projection);
var svg = d3.select("svg")
            .append("g")
            .attr("width", width)
            .attr("height", height);
var bar = d3.select("#bar")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform",
                      "translate(" + margin.left + "," + margin.top + ")");
var tooltip = d3.select("div.tooltip");
d3.queue()
  .defer(d3.json, "world-atlas.json")
  .defer(d3.csv, "world-country-names.csv")
  .defer(d3.csv, "armSalesData.csv")
  .await(ready);
function ready(error, world, names, tiv) {
  if (error) throw error;
  var countries1 = topojson.feature(world, world.objects.countries).features;
    countries = countries1.filter(function(d) {
    return names.some(function(n) {
      if (d.id == n.id) 
          return d.name = n.name;   
    })});
    
    countries.map(function (d) {
        names.filter(function (n) {
          if (d.id == n.id) {
            return (d.subregion = n.subregion);
          }
        tiv.filter(function(t){
          if (d.name == t.country){
            (d.twentytens = t.twentytens);
            (d.twothousands = d.twothousands);
            (d.nineties = d.nineties);
            (d.eighties = d.eighties);
            (d.seventies = d.seventies);
            (d.sixties = d.sixties);
            (d.fifties = d.fifties);
          }
        })
        });
      });
         svg.selectAll("path")
			.data(countries)
			.enter()
			.append("path")
			.attr("stroke","black")
			.attr("stroke-width",0.65)
            .attr("fill", "grey")
			.attr("d", path )
            .on("mousemove",showTooltip)
			.on("mouseover",hoverColorChange)
            .on("mouseout", removeTooltip);
    //console.log(tiv);
    var dec = ["fifties", "sixties", "seventies", "eighties", "nineties", "twothousands", "twentytens"]; //Each decade represented in tiv data
    var decades = [{fifties: []}, {sixties: []}, {seventies: []}, {eighties: []}, {nineties: []}, {twothousands: []}, {twentytens: []}]; //Organized dataset
    tiv.map(function(country) {
        //console.log(country);
        for (var x = 0; x < dec.length; x++) {
            var pair = {country: country.country,
                        tiv: country[dec[x]]};
            decades[x][dec[x]].push(pair);
        }
    })
    //console.log(decades);
    for (var x = 0; x < dec.length; x++) { //Sorts each decade, least to most
        decades[x][dec[x]] = decades[x][dec[x]].sort(function (a,b) {
            return a.tiv - b.tiv;
        })
    }
    var chosen = 6; //Index for the current decade
    var top10 = []; //Empty array for top 10 countries from each decade
    for (var x = 0; x < dec.length; x++) { //Gets top 10 countries from each decade
        top10.push(decades[x][dec[x]].slice(160, 170));
    }
    //console.log(decades);
    //console.log(top10);
    var x = d3.scaleBand() //x axis
        .range([0,width])
        .domain(top10[chosen].map(function(decade) {
            return decade.country;
        }))
        .padding(0.2);

    bar.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x))
        .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end")
            .attr("font-size" , "13px");
    topval = top10[chosen].map(function (country) { 
        return parseInt(country.tiv);    
    });
    //console.log(topval);
    var y = d3.scaleLinear()
        .domain([0, Math.max(...topval)])
        .range([height, 0])
    bar.append("g")
        .call(d3.axisLeft(y));
    
    console.log(top10[chosen]);
    
    bar.selectAll("rect")
        .data(top10[chosen])
        .enter()
        .append("rect")
        .attr("x", function(d) { return x(d.country); })
        .attr("y", function(d) { return y(parseInt(d.tiv)); })
        .attr("width", x.bandwidth())
        .attr("height", function(d) { return height - y(d.tiv); })
        .attr("fill", "grey");
    /*bar.selectAll("text")
        .data(top10[chosen])
        .enter()
        .append("text")
        .text(function(d) {
            return parseInt(d.tiv);
        })
        .attr("x", function(d) {
            return x(d.country) + x.bandwidth() / 3.3;
        })
        .attr("y", function(d) {
            return y(parseInt(d.tiv));
        })
        .attr("font-family" , "sans-serif")
        .attr("font-size" , "13px")
        .attr("text-anchor", "middle");*/
};
    
var fillColor = d3.scaleThreshold()
    .domain([10, 100, 250, 500,1000,2500, 5000, 10000])
    .range(d3.schemeOrRd[9]);

function hoverColorChange(d){
    if (typeof d.twentytens == 'undefined'){
        d.twentytens = "0"
    }
    d3.select(this).attr("fill", function(d) {
        if (d.twentytens == 0 || d.twentytens == -1){
            d3.select(this).attr("opacity",0.5)
            return "grey";
        }
        return fillColor(d.twentytens); 
    });
};
    
function showTooltip(d){
    if (typeof d.twentytens == 'undefined'){
        d.twentytens = "0"
    }
    tooltip.classed("hidden", false)
        .style("top", (d3.event.pageY) + "px")
        .style("left", (d3.event.pageX + 10) + "px")
        .html(
        "<table>" +
        "<tr><th>" +
        d.name +
        "</tr></th>"+
        "<tr><td>"+
        d.subregion+
        "</tr><td>"+
        "<tr><td>"+
        d.twentytens+
        "</tr><td>"+
        "</table>"              
        );
}
    
function changebar (decade) {
    chosen = decade;
}

function removeTooltip(d){
    d3.select(this).attr("fill","grey").attr("stroke-width",0.65).attr("opacity",1);
    tooltip.classed("hidden", true);
};
</script>
</body>

<!--
<div id="option">
        <input
        name="1950s"
        type="button"
        value="1950s"
        onclick="toggleCountyBoundary();changebar('0');"
      />
        <input
        name="1960s"
        type="button"
        value="1960s"
        onclick="toggleCountyBoundary();changebar('1');"
      />
        <input
        name="1970s"
        type="button"
        value="1970s"
        onclick="toggleCountyBoundary();changebar('2');"
      />
        <input
        name="1980s"
        type="button"
        value="1980s"
        onclick="toggleCountyBoundary();changebar('3');"
      />
        <input
        name="1990s"
        type="button"
        value="1990s"
        onclick="toggleCountyBoundary();changebar('4');"
      />
        <input
        name="2000s"
        type="button"
        value="2000s"
        onclick="toggleCountyBoundary();changebar('5');"
      />
        <input
        name="2010s"
        type="button"
        value= "2010s"
        onclick="toggleCountyBoundary();changebar('6');"
      />
    </div>
 -->
<div id="option">
        <input
        name="1950s"
        type="button"
        value="1950s"
        onclick="changebar('0');"
      />
        <input
        name="1960s"
        type="button"
        value="1960s"
        onclick="changebar('1');"
      />
        <input
        name="1970s"
        type="button"
        value="1970s"
        onclick="changebar('2');"
      />
        <input
        name="1980s"
        type="button"
        value="1980s"
        onclick="changebar('3');"
      />
        <input
        name="1990s"
        type="button"
        value="1990s"
        onclick="changebar('4');"
      />
        <input
        name="2000s"
        type="button"
        value="2000s"
        onclick="changebar('5');"
      />
        <input
        name="2010s"
        type="button"
        value= "2010s"
        onclick="changebar('6');"
      />
    </div>